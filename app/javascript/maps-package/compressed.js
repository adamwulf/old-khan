com={redfin:{}};com.redfin.FastMarkerOverlay=function(a,b){this.setMap(a);this._markers=b};com.redfin.FastMarkerOverlay.prototype=new google.maps.OverlayView();com.redfin.FastMarkerOverlay.prototype.onAdd=function(){this._div=document.createElement("div");var a=this.getPanes();a.overlayLayer.appendChild(this._div)};com.redfin.FastMarkerOverlay.prototype.copy=function(c){var d=this._markers;var a=d.length;var b=new Array(a);while(a--){b[a]=d[a].copy()}return new com.redfin.FastMarkerOverlay(c,d)};com.redfin.FastMarkerOverlay.prototype.draw=function(){if(!this._div){return}var c=this.getProjection();var g=this._markers.length;var e=[];while(g--){var a=this._markers[g];var h=c.fromLatLngToDivPixel(a._latLng);e.push("<div style='position:absolute; left:");e.push(h.x+a._leftOffset);e.push("px; top:");e.push(h.y+a._topOffset);e.push("px;");if(a._zIndex){e.push(" z-index:");e.push(a._zIndex);e.push(";")}e.push("'");if(a._divClassName){e.push(" class='");e.push(a._divClassName);e.push("'")}e.push(" id='");e.push(a._id);e.push("' >");var f=a._htmlTextArray;var d=f.length;var b=e.length;while(d--){e[d+b]=f[d]}e.push("</div>")}this._div.innerHTML=e.join("")};com.redfin.FastMarkerOverlay.prototype.hide=function(){if(!this._div){return}this._div.style.display="none"};com.redfin.FastMarkerOverlay.prototype.unhide=function(){if(!this._div){return}this._div.style.display="block"};com.redfin.FastMarkerOverlay.prototype.onRemove=function(){this._div.parentNode.removeChild(this._div);this._div=null};com.redfin.FastMarker=function(g,d,b,c,f,e,a){this._id=g;this._latLng=d;this._htmlTextArray=b;this._divClassName=c;this._zIndex=f;this._leftOffset=e||0;this._topOffset=a||0};com.redfin.FastMarker.prototype.copy=function(){var c=this._htmlTextArray;var b=c.length;var a=new Array(b);while(b--){a[b]=c[b]}return new com.redfin.FastMarker(this._id,latLng,a,this._divClassName,this._zIndex,this._leftOffset,this._topOffset)};var KnowledgeMap={map:null,overlay:null,dictNodes:{},dictEdges:[],markers:[],widthPoints:200,heightPoints:120,colors:{blue:"#0080C9",green:"#8EBE4F",red:"#E35D04",gray:"#FFFFFF"},icons:{Exercise:{Proficient:"/images/node-complete.png?"+KA_VERSION,Review:"/images/node-review.png?"+KA_VERSION,Suggested:"/images/node-suggested.png?"+KA_VERSION,Normal:"/images/node-not-started.png?"+KA_VERSION},Summative:{Normal:"images/node-challenge-not-started.png?"+KA_VERSION,Proficient:"images/node-challenge-complete.png?"+KA_VERSION,Suggested:"images/node-challenge-suggested.png?"+KA_VERSION}},latLngHome:new google.maps.LatLng(-0.064844,0.736268),latMin:90,latMax:-90,lngMin:180,lngMax:-180,nodeSpacing:{lat:0.392,lng:0.35},latLngBounds:null,reZoom:/nodeLabelZoom(\d)+/g,reHidden:/nodeLabelHidden/g,fFirstDraw:true,fCenterChanged:false,fZoomChanged:false,options:{getTileUrl:function(b,a){return KnowledgeMap.getHorizontallyRepeatingTileUrl(b,a,function(d,c){return"http://mw1.google.com/mw-planetary/sky/skytiles_v1/"+d.x+"_"+d.y+"_"+c+".jpg"})},tileSize:new google.maps.Size(256,256),maxZoom:10,minZoom:7,isPng:false},init:function(d,c,a){this.discoverGraph();this.map=new google.maps.Map(document.getElementById("map-canvas"),{mapTypeControl:false,streetViewControl:false,scrollwheel:false});var b=new google.maps.ImageMapType(this.options);this.map.mapTypes.set("knowledge",b);this.map.setMapTypeId("knowledge");if(d&&c&&a){this.map.setCenter(new google.maps.LatLng(d,c));this.map.setZoom(a)}else{this.map.setCenter(this.latLngHome);this.map.setZoom(this.options.minZoom+2)}this.layoutGraph();this.drawOverlay();this.latLngBounds=new google.maps.LatLngBounds(new google.maps.LatLng(this.latMin,this.lngMin),new google.maps.LatLng(this.latMax,this.lngMax)),google.maps.event.addListener(this.map,"center_changed",function(){KnowledgeMap.onCenterChange()});google.maps.event.addListener(this.map,"idle",function(){KnowledgeMap.onIdle()});this.giveNasaCredit()},escapeSelector:function(a){return a.replace(/(:|\.)/g,"\\$1")},giveNasaCredit:function(){var a=$("<div class='creditLabel'>Image Credit: SDSS, DSS Consortium, NASA/ESA/STScI</div>");a[0].index=0;this.map.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push(a[0])},discoverGraph:function(){$("table.hidden_knowledge_map tr[data-id]").each(function(){var a=$(this);KnowledgeMap.addNode({id:a.attr("data-id"),name:a.attr("data-name"),h_position:a.attr("data-h_position"),v_position:a.attr("data-v_position"),status:a.attr("data-status"),summative:a.attr("data-summative")=="True",url:"/exercises?exid="+a.attr("data-id")})});$("table.hidden_knowledge_map tr[data-id]").each(function(){var c=$(this);var b=c.attr("data-id");var a=c.attr("data-summative")=="True";c.find("li[data-prereq]").each(function(d){var e=$(this).attr("data-prereq");KnowledgeMap.addEdge(b,e,a)})})},layoutGraph:function(){var d=this.map.getZoom();for(var c in this.dictNodes){this.drawMarker(this.dictNodes[c],d)}for(var c in this.dictEdges){var b=this.dictEdges[c];for(var a=0;a<b.length;a++){this.drawEdge(this.dictNodes[c],b[a],d)}}},drawOverlay:function(){this.overlay=new com.redfin.FastMarkerOverlay(this.map,this.markers);this.overlay.drawOriginal=this.overlay.draw;this.overlay.draw=function(){this.drawOriginal();var a=$(".nodeLabel");if(!KnowledgeMap.fFirstDraw){KnowledgeMap.onZoomChange(a)}a.each(function(){KnowledgeMap.attachNodeEvents(this,KnowledgeMap.dictNodes[$(this).attr("data-id")])});KnowledgeMap.fFirstDraw=false}},attachNodeEvents:function(a,b){$(a).click(function(){KnowledgeMap.onNodeClick(b)}).hover(function(){KnowledgeMap.onNodeMouseover(this,b)},function(){KnowledgeMap.onNodeMouseout(this,b)})},addNode:function(a){this.dictNodes[a.id]=a},addEdge:function(c,d,b){if(!this.dictEdges[c]){this.dictEdges[c]=[]}var a=this.dictEdges[c];a[a.length]={target:d,summative:b}},nodeStatusCount:function(b){var d=0;for(var a=1;a<arguments.length;a++){if(arguments[a].status==b){d++}}return d},drawEdge:function(b,k,j){var i=this.dictNodes[k.target];var h=[b.latLng,i.latLng];var g=this.nodeStatusCount("Proficient",b,i);var a=this.nodeStatusCount("Suggested",b,i);var e=this.nodeStatusCount("Review",b,i);var c=this.colors.gray;var d=1;var f=0.48;if(g==2){c=this.colors.blue;d=5;f=1}else{if(g==1&&a==1){c=this.colors.green;d=5;f=1}else{if(e>0){c=this.colors.red;d=5;f=1}}}k.line=new google.maps.Polyline({path:h,strokeColor:c,strokeOpacity:f,strokeWeight:d,clickable:false,map:this.getMapForEdge(k,j)})},drawMarker:function(c,i){var e=-1*(c.h_position-1)*this.nodeSpacing.lat;var f=(c.v_position-1)*this.nodeSpacing.lng;c.latLng=new google.maps.LatLng(e,f);if(e<this.latMin){this.latMin=e}if(e>this.latMax){this.latMax=e}if(f<this.lngMin){this.lngMin=f}if(f>this.lngMax){this.lngMax=f}var g=this.icons[c.summative?"Summative":"Exercise"];var a=g[c.status];if(!a){a=g.Normal}var h="nodeLabel nodeLabel"+c.status;if(c.summative){h+=" nodeLabelSummative"}c.iconUrl=a;var b=this.getIconOptions(c,i);var d=new com.redfin.FastMarker("marker-"+c.id,c.latLng,["<div id='node-"+c.id+"' data-id='"+c.id+"' class='"+this.getLabelClass(h,c,i)+"'><img src='"+b.url+"'/><div>"+c.name+"</div></div>"],"",c.summative?2:1,0,0);this.markers[this.markers.length]=d},getMapForEdge:function(b,a){return((a==this.options.minZoom)==b.summative)?this.map:null},getIconOptions:function(e,d){var c=e.iconUrl;var a=c+"@"+d;if(!this.iconCache){this.iconCache={}}if(!this.iconCache[a]){var b=c;if(!e.summative&&d<=this.options.minZoom){b=c.replace(".png","-star.png")}this.iconCache[a]={url:b}}return this.iconCache[a]},getLabelClass:function(a,c,b){var d=!c.summative||b==this.options.minZoom;a=a.replace(this.reHidden,"")+(d?"":" nodeLabelHidden");if(c.summative&&d){b=this.options.maxZoom-1}a=a.replace(this.reZoom,"")+(" nodeLabelZoom"+b);return a},highlightNode:function(b,a){var c=$("#node-"+KnowledgeMap.escapeSelector(b.id));if(a){c.addClass("nodeLabelHighlight")}else{c.removeClass("nodeLabelHighlight")}},onNodeClick:function(a){if(!a.summative&&this.map.getZoom()<=this.options.minZoom){return}window.location=a.url},onNodeMouseover:function(a,b){if(a.nodeName.toLowerCase()!="div"){return}if(!b.summative&&this.map.getZoom()<=this.options.minZoom){return}$('.exercise-badge[data-id="'+KnowledgeMap.escapeSelector(b.id)+'"]').addClass("exercise-badge-hover");this.highlightNode(b,true)},onNodeMouseout:function(a,b){if(a.nodeName.toLowerCase()!="div"){return}if(!b.summative&&this.map.getZoom()<=this.options.minZoom){return}$('.exercise-badge[data-id="'+KnowledgeMap.escapeSelector(b.id)+'"]').removeClass("exercise-badge-hover");this.highlightNode(b,false)},onBadgeMouseover:function(){var b=$(this).attr("data-id");var a=KnowledgeMap.dictNodes[b];if(a){KnowledgeMap.highlightNode(a,true)}},onBadgeMouseout:function(){var b=$(this).attr("data-id");var a=KnowledgeMap.dictNodes[b];if(a){KnowledgeMap.highlightNode(a,false)}},onZoomChange:function(d){var f=this.map.getZoom();if(f<this.options.minZoom){return}if(f>this.options.maxZoom){return}this.fZoomChanged=true;d.each(function(){var j=$(this);var i=KnowledgeMap.dictNodes[j.attr("data-id")];var h=KnowledgeMap.getIconOptions(i,f);$("img",j).attr("src",h.url);j.attr("class",KnowledgeMap.getLabelClass(j.attr("class"),i,f))});for(var e in this.dictEdges){var c=this.dictEdges[e];for(var b=0;b<c.length;b++){var a=c[b].line;var g=this.getMapForEdge(c[b],f);if(a.getMap()!=g){a.setMap(g)}}}},onIdle:function(){if(!this.fCenterChanged&&!this.fZoomChanged){return}KnowledgeMap.map.panBy(0,0);var a=this.map.getCenter();$.post("/savemapcoords",{lat:a.lat(),lng:a.lng(),zoom:this.map.getZoom()})},onCenterChange:function(){this.fCenterChanged=true;var a=this.map.getCenter();if(this.latLngBounds.contains(a)){return}var g=a;var h=g.lng();var f=g.lat();var c=this.latLngBounds.getNorthEast().lng();var b=this.latLngBounds.getNorthEast().lat();var e=this.latLngBounds.getSouthWest().lng();var d=this.latLngBounds.getSouthWest().lat();if(h<e){h=e}if(h>c){h=c}if(f<d){f=d}if(f>b){f=b}this.map.setCenter(new google.maps.LatLng(f,h))},getHorizontallyRepeatingTileUrl:function(f,c,b){var e=f.y;var a=f.x;var d=1<<c;if(e<0||e>=d){return null}if(a<0||a>=d){a=(a%d+d)%d}return b({x:a,y:e},c)}};